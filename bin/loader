#!/usr/bin/env node

/* jslint node: true, esnext: true */

'use strict';

const symatem = require('symatem'),
  fs = require('fs');

const symbolCache = {};

symatem.open().then(connection =>
  connection.upload(fs.readFileSync('../de.mfelten.infrastructure/assets.sym'))
  .then(result => {
    return connection.upload('networkInterface').then(result => {
      connection.query(false, symatem.queryMask.VMV, 0, result[0], 0).then(ipas => {
        //console.log(ipas);
        Promise.all(ipas.map(symbol => {
          if (symbolCache[symbol]) {
            console.log(`already found: ${symbol}`);
            return Promise.resolve(symbolCache[symbol]);
          }
          return connection.decodeSymbol(symbol).then(decoded => {
            console.log(`add ${symbol} -> ${decoded.name}`);
            symbolCache[symbol] = decoded;
            return decoded;
          });
        })).then(
          decoded => {
            for (let i = 0; i < decoded.length; i += 2) {
              const a = decoded[i + 0];
              delete a.BlobType;
              delete a.networkInterface;

              const b = decoded[i + 1];
              delete b.BlobType;

              console.log(`${JSON.stringify(a)} <> ${JSON.stringify(b)}`);
            }
          }
        );
      });
    });
  })
  .catch(result => console.error(result)));
